<!DOCTYPE html>
<html>
<head>
  <title>Monthly Analytics - Finance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="storage.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background:#f2f2f2; }
    button { padding:10px 20px; margin:10px 5px 10px 0; border:none; border-radius:5px; cursor:pointer; }
    .back-btn { background:#2196F3; color:white; }
    .card { background:white; padding:15px; margin-top:15px; border-radius:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .chart-container { position: relative; height: 300px; margin-top: 20px; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
    .month-filter { margin-bottom: 20px; }
    .month-filter select { padding: 10px; font-size: 16px; width: 200px; }
    .reset-btn { background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; margin: 8px 0; }
    .stat-card.income { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.expense { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card h4 { margin: 0 0 10px 0; font-size: 12px; opacity: 0.9; }
    .stat-card .value { font-size: 20px; font-weight: bold; }
    h2 { color: #333; margin-bottom: 20px; }
  </style>
</head>
<body>

<h2>üìÖ Monthly Analytics</h2>
<a href="analytics.html"><button class="back-btn">‚Üê Back to Analytics</button></a>

<div class="card">
  <h3>Monthly Analytics</h3>
  
  <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
    <div class="month-filter">
      <label for="monthSelect"><strong>Select Month:</strong></label>
      <select id="monthSelect" onchange="updateMonthlyAnalytics()">
        <option value="">-- Current Month --</option>
      </select>
    </div>
    <button class="reset-btn" onclick="resetMonthlyData()">üóëÔ∏è Reset Current Month</button>
  </div>

  <!-- Monthly Stats -->
  <div id="monthlyStats"></div>

  <!-- Monthly Charts -->
  <div class="chart-grid">
    <div class="card">
      <h4>Monthly Expenses by Label</h4>
      <div class="chart-container">
        <canvas id="monthlyExpenseChart"></canvas>
      </div>
    </div>

    <div class="card">
      <h4>Monthly Income by Label</h4>
      <div class="chart-container">
        <canvas id="monthlyIncomeChart"></canvas>
      </div>
    </div>

    <div class="card">
      <h4>Monthly Trend</h4>
      <div class="chart-container">
        <canvas id="monthlyTrendChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Monthly Transactions -->
  <div class="card" style="margin-top: 20px;">
    <h3>Transactions for Selected Month</h3>
    <table id="monthlyTransactionsTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
      <thead>
        <tr style="background: #f5f5f5;">
          <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Date</th>
          <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Type</th>
          <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Label</th>
          <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Account</th>
          <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">Amount</th>
        </tr>
      </thead>
      <tbody id="monthlyTransactionsBody"></tbody>
    </table>
  </div>
</div>

<script>
function getMonthKey(dateStr) {
  const [month, day, year] = dateStr.split('/');
  return year + '-' + String(month).padStart(2, '0');
}

function getTransactionsForMonth(transactions, monthKey) {
  return transactions.filter(t => getMonthKey(t.date) === monthKey);
}

function getMonthlyStats(monthKey, transactions) {
  const monthTx = getTransactionsForMonth(transactions, monthKey);
  let income = 0, expense = 0;
  monthTx.forEach(t => {
    const amt = parseFloat(t.amount);
    if (t.type === 'income') income += amt;
    else expense += amt;
  });
  return { income, expense, net: income - expense };
}

function getMonthsByTransactions(transactions) {
  const months = [...new Set(transactions.map(t => getMonthKey(t.date)))].sort().reverse();
  return months;
}

function populateMonthSelect() {
  const rawData = localStorage.getItem('financeData');
  if (!rawData) return;
  
  const transactions = JSON.parse(rawData);
  const months = getMonthsByTransactions(transactions);
  const select = document.getElementById('monthSelect');
  
  select.innerHTML = '<option value="">-- Current Month --</option>';
  months.forEach(month => {
    const [year, m] = month.split('-');
    const monthName = new Date(year, parseInt(m) - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
    const opt = document.createElement('option');
    opt.value = month;
    opt.textContent = monthName;
    select.appendChild(opt);
  });
}

function updateMonthlyAnalytics() {
  const rawData = localStorage.getItem('financeData');
  if (!rawData) return;
  
  const transactions = JSON.parse(rawData);
  const select = document.getElementById('monthSelect');
  const selectedMonth = select.value || (new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0'));
  
  const monthTx = getTransactionsForMonth(transactions, selectedMonth);
  const stats = getMonthlyStats(selectedMonth, transactions);
  
  // Update stats display
  const statsDiv = document.getElementById('monthlyStats');
  if (statsDiv) {
    statsDiv.innerHTML = `
      <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;">
        <div class="stat-card income">
          <h4>Income</h4>
          <div class="value">$${stats.income.toFixed(2)}</div>
        </div>
        <div class="stat-card expense">
          <h4>Expense</h4>
          <div class="value">$${stats.expense.toFixed(2)}</div>
        </div>
        <div class="stat-card">
          <h4>Net</h4>
          <div class="value">$${stats.net.toFixed(2)}</div>
        </div>
      </div>
    `;
  }
  
  // Build label breakdowns
  const expenseByLabel = {};
  const incomeByLabel = {};
  monthTx.forEach(t => {
    const amt = parseFloat(t.amount);
    if (t.type === 'income') incomeByLabel[t.label] = (incomeByLabel[t.label] || 0) + amt;
    else expenseByLabel[t.label] = (expenseByLabel[t.label] || 0) + amt;
  });
  
  const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
  
  // Chart 1: Expenses
  const ctx1 = document.getElementById('monthlyExpenseChart')?.getContext('2d');
  if (ctx1 && window.Chart) {
    if (window.expChart) window.expChart.destroy();
    const labels = Object.keys(expenseByLabel);
    window.expChart = new Chart(ctx1, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: Object.values(expenseByLabel),
          backgroundColor: colors.slice(0, labels.length),
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
    });
  }
  
  // Chart 2: Income
  const ctx2 = document.getElementById('monthlyIncomeChart')?.getContext('2d');
  if (ctx2 && window.Chart) {
    if (window.incChart) window.incChart.destroy();
    const labels = Object.keys(incomeByLabel);
    window.incChart = new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: Object.values(incomeByLabel),
          backgroundColor: colors.slice(0, labels.length),
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
    });
  }
  
  // Chart 3: Trend (Income vs Expense over time for this month)
  const ctx3 = document.getElementById('monthlyTrendChart')?.getContext('2d');
  if (ctx3 && window.Chart) {
    if (window.trendChart) window.trendChart.destroy();
    window.trendChart = new Chart(ctx3, {
      type: 'line',
      data: {
        labels: ['Income', 'Expense'],
        datasets: [{
          label: 'Amount',
          data: [stats.income, stats.expense],
          borderColor: '#2196F3',
          backgroundColor: 'rgba(33, 150, 243, 0.1)',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true, ticks: { callback: (v) => '$' + v.toFixed(0) } } }
      }
    });
  }
  
  // Transactions table
  const tbody = document.getElementById('monthlyTransactionsBody');
  if (tbody) {
    tbody.innerHTML = '';
    monthTx.forEach(t => {
      const row = document.createElement('tr');
      row.style.borderBottom = '1px solid #eee';
      row.innerHTML = `
        <td style="padding:10px;">${t.date}</td>
        <td style="padding:10px;">${t.type}</td>
        <td style="padding:10px;">${t.label}</td>
        <td style="padding:10px;">${t.account}</td>
        <td style="padding:10px; text-align:right;">$${parseFloat(t.amount).toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    });
  }
}

function resetMonthlyData() {
  if (!confirm('Delete all transactions for the current month? This cannot be undone!')) return;
  
  const now = new Date();
  const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  
  let transactions = JSON.parse(localStorage.getItem('financeData')) || [];
  transactions = transactions.filter(t => getMonthKey(t.date) !== currentMonth);
  localStorage.setItem('financeData', JSON.stringify(transactions));
  
  alert('Current month reset!');
  populateMonthSelect();
  updateMonthlyAnalytics();
}

// Initialize
setTimeout(() => {
  populateMonthSelect();
  updateMonthlyAnalytics();
}, 100);
</script>

</body>
</html>
