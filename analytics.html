<!DOCTYPE html>
<html>
<head>
  <title>Analytics - Finance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="storage.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background:#f2f2f2; }
    button { padding:10px 20px; margin:10px 5px 10px 0; border:none; border-radius:5px; cursor:pointer; }
    .back-btn { background:#2196F3; color:white; }
    .card { background:white; padding:15px; margin-top:15px; border-radius:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
    .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
    .stat-box.income { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-box.expense { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-box h3 { margin: 0; font-size: 14px; opacity: 0.9; }
    .stat-box .value { font-size: 28px; font-weight: bold; margin-top: 10px; }
    .chart-container { position: relative; height: 300px; margin-top: 20px; }
    h2 { color: #333; margin-bottom: 20px; }
    .filter-btn { background: #9C27B0; color: white; }
    .filter-btn.active { background: #7B1FA2; }
    .top-nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .label-filter { margin-top: 20px; }
    .label-filter select { width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; }
    .label-details { margin-top: 20px; }
    .label-details table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .label-details th, .label-details td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    .label-details th { background: #f5f5f5; font-weight: bold; }
    .label-details tr:hover { background: #f9f9f9; }
    .label-total { background: #e8f5e9; font-weight: bold; font-size: 18px; color: #2e7d32; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
    .chart-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
    .chart-card:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .chart-card.small { position: relative; height: 300px; }
    .zoom-icon { position: absolute; top: 10px; right: 10px; background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; z-index: 10; }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); overflow: auto; }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background-color: white; padding: 30px; border-radius: 10px; width: 90%; height: 90%; max-width: 1200px; position: relative; display: flex; flex-direction: column; }
    .modal-close { position: absolute; top: 20px; right: 20px; background: #f44336; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; z-index: 101; }
    .modal-chart { flex: 1; position: relative; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
    .tab-btn { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; color: #666; border-bottom: 3px solid transparent; }
    .tab-btn.active { color: #2196F3; border-bottom-color: #2196F3; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .month-filter { margin-bottom: 20px; }
    .month-filter select { padding: 10px; font-size: 16px; width: 200px; }
    .reset-btn { background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-card.income { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.expense { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card h4 { margin: 0 0 10px 0; font-size: 12px; opacity: 0.9; }
    .stat-card .value { font-size: 20px; font-weight: bold; }
      .label-compare-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:8px; margin-top:8px; }
      .label-compare-item { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; background:#fff; }
      .label-compare-item.selected { background:#e8f5e9; border-color:#c8e6c9; }
      .label-compare-item .add-btn { background:#4CAF50; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:bold; }
      .label-compare-item .add-btn.selected { background:#2e7d32; }
  </style>
</head>
<body>

<h2>Financial Analytics</h2>
<div id="debugInfo" style="font-size:13px; color:#666; margin-bottom:8px;">‚è≥ Loading...</div>
<div id="storageDebug" style="font-size:11px; color:#999; margin-bottom:8px; max-width:600px; word-break:break-all;"></div>
<div style="margin-bottom:12px;"><button id="reloadDataBtn" style="padding:6px 10px; background:#1976D2; color:white; border:none; border-radius:6px; cursor:pointer;" onclick="initCharts()">Reload Data</button></div>

<script>
// Direct inline init - no dependencies, just read and display
function initCharts() {
  try {
    const rawData = localStorage.getItem('financeData');
    if (!rawData) {
      document.getElementById('debugInfo').textContent = 'No transactions in storage';
      return;
    }
    
    const transactions = JSON.parse(rawData);
    document.getElementById('debugInfo').textContent = 'Transactions loaded: ' + transactions.length;
    
    if (!Array.isArray(transactions) || transactions.length === 0) {
      document.getElementById('debugInfo').textContent = 'No transactions yet';
      return;
    }
    
    // Color palette
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];
    
    // Calculate totals
    let totalIncome = 0, totalExpense = 0;
    let expenseByLabel = {}, incomeByLabel = {};
    let cashIncome = 0, cashExpense = 0, bankIncome = 0, bankExpense = 0;
    
    transactions.forEach(t => {
      const amt = parseFloat(t.amount);
      const account = (t.account || '').toString().replace(/[^\x00-\x7F]/g, '').trim() || 'Bank';
      const isCash = /cash/i.test(account);
      
      if (t.type === 'income') {
        totalIncome += amt;
        incomeByLabel[t.label] = (incomeByLabel[t.label] || 0) + amt;
        if (isCash) cashIncome += amt;
        else bankIncome += amt;
      } else if (t.type === 'expense') {
        totalExpense += amt;
        expenseByLabel[t.label] = (expenseByLabel[t.label] || 0) + amt;
        if (isCash) cashExpense += amt;
        else bankExpense += amt;
      }
    });
    
    const netBalance = totalIncome - totalExpense;
    
    // Update stat boxes
    if (document.getElementById('totalIncome')) document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
    if (document.getElementById('totalExpense')) document.getElementById('totalExpense').textContent = totalExpense.toFixed(2);
    if (document.getElementById('netBalance')) document.getElementById('netBalance').textContent = netBalance.toFixed(2);
    if (document.getElementById('cash')) document.getElementById('cash').textContent = (cashIncome - cashExpense).toFixed(2);
    if (document.getElementById('bank')) document.getElementById('bank').textContent = (bankIncome - bankExpense).toFixed(2);
    
    // Chart 1: Income vs Expense
    const ctx1 = document.getElementById('incomeExpenseChart')?.getContext('2d');
    if (ctx1 && window.Chart) {
      if (window.chart1) window.chart1.destroy();
      window.chart1 = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: ['Income', 'Expense'],
          datasets: [{
            label: 'Amount ($)',
            data: [totalIncome, totalExpense],
            backgroundColor: ['#f093fb', '#4facfe'],
            borderColor: ['#f5576c', '#00f2fe'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true, ticks: { callback: (v) => '$' + v.toFixed(0) } } }
        }
      });
    }
    
    // Chart 2: Expense by Label
    const expLabels = Object.keys(expenseByLabel);
    const expAmounts = Object.values(expenseByLabel);
    const ctx2 = document.getElementById('expenseByLabelChart')?.getContext('2d');
    if (ctx2 && window.Chart && expLabels.length > 0) {
      if (window.chart2) window.chart2.destroy();
      window.chart2 = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: expLabels,
          datasets: [{
            data: expAmounts,
            backgroundColor: colors.slice(0, expLabels.length),
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });
    }
    
    // Chart 3: Income by Label
    const incLabels = Object.keys(incomeByLabel);
    const incAmounts = Object.values(incomeByLabel);
    const ctx3 = document.getElementById('incomeByLabelChart')?.getContext('2d');
    if (ctx3 && window.Chart && incLabels.length > 0) {
      if (window.chart3) window.chart3.destroy();
      window.chart3 = new Chart(ctx3, {
        type: 'doughnut',
        data: {
          labels: incLabels,
          datasets: [{
            data: incAmounts,
            backgroundColor: colors.slice(0, incLabels.length),
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });
    }
    
    // Chart 4: Account Breakdown
    const ctx4 = document.getElementById('accountChart')?.getContext('2d');
    if (ctx4 && window.Chart) {
      if (window.chart4) window.chart4.destroy();
      window.chart4 = new Chart(ctx4, {
        type: 'bar',
        data: {
          labels: ['Cash', 'Bank'],
          datasets: [
            {
              label: 'Income',
              data: [cashIncome, bankIncome],
              backgroundColor: '#f093fb',
              borderColor: '#f5576c',
              borderWidth: 1
            },
            {
              label: 'Expense',
              data: [cashExpense, bankExpense],
              backgroundColor: '#4facfe',
              borderColor: '#00f2fe',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true, ticks: { callback: (v) => '$' + v.toFixed(0) } } }
        }
      });
    }
    
    // Populate label selects
    const allLabels = [...new Set(transactions.map(t => t.label))].sort();
    
    // Populate main label select
    const labelSelect = document.getElementById('labelSelect');
    if (labelSelect) {
      labelSelect.innerHTML = '<option value="">-- Select a Label --</option>';
      allLabels.forEach(label => {
        const opt = document.createElement('option');
        opt.value = label;
        opt.textContent = label;
        labelSelect.appendChild(opt);
      });
    }
    
    // Populate label comparison list
    const labelCompareList = document.getElementById('labelCompareList');
    if (labelCompareList) {
      labelCompareList.innerHTML = '';
      allLabels.forEach(label => {
        const item = document.createElement('div');
        item.className = 'label-compare-item';
        item.id = 'compare-item-' + label;
        
        const span = document.createElement('span');
        span.textContent = label;
        
        const btn = document.createElement('button');
        btn.className = 'add-btn';
        btn.textContent = '+';
        btn.title = 'Add to compare';
        btn.onclick = () => toggleCompareLabel(label, item, btn, transactions);
        
        item.appendChild(span);
        item.appendChild(btn);
        labelCompareList.appendChild(item);
      });
    }
    
    document.getElementById('debugInfo').textContent = '‚úì Charts created! Income: $' + totalIncome.toFixed(2) + ', Expense: $' + totalExpense.toFixed(2) + ', Net: $' + netBalance.toFixed(2);
  } catch (e) {
    document.getElementById('debugInfo').textContent = 'ERROR: ' + e.message;
    console.error(e);
  }
}

// Label comparison tracking
window.selectedCompareLabels = [];

function toggleCompareLabel(label, itemEl, btnEl, transactions) {
  const idx = window.selectedCompareLabels.indexOf(label);
  if (idx === -1) {
    window.selectedCompareLabels.push(label);
    itemEl.classList.add('selected');
    btnEl.classList.add('selected');
    btnEl.textContent = '‚úì';
  } else {
    window.selectedCompareLabels.splice(idx, 1);
    itemEl.classList.remove('selected');
    btnEl.classList.remove('selected');
    btnEl.textContent = '+';
  }
  
  const compareBtn = document.getElementById('compareBtn');
  if (compareBtn) compareBtn.disabled = window.selectedCompareLabels.length < 2;
}

function showLabelDetails() {
  const rawData = localStorage.getItem('financeData');
  if (!rawData) return;
  
  const transactions = JSON.parse(rawData);
  const selectedLabel = document.getElementById('labelSelect')?.value;
  const detailsContainer = document.getElementById('labelDetailsContainer');
  
  if (!selectedLabel) {
    if (detailsContainer) detailsContainer.style.display = 'none';
    return;
  }
  
  const labelTransactions = transactions.filter(t => t.label === selectedLabel);
  const tbody = document.getElementById('labelDetailsBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  let totalAmount = 0;
  
  labelTransactions.forEach(t => {
    const amount = parseFloat(t.amount);
    totalAmount += amount;
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${t.date}</td>
      <td>${t.type}</td>
      <td>${t.account}</td>
      <td>$${amount.toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });
  
  const totalRow = document.createElement('tr');
  totalRow.className = 'label-total';
  totalRow.innerHTML = `<td colspan="3" style="text-align: right;">TOTAL</td><td>$${totalAmount.toFixed(2)}</td>`;
  tbody.appendChild(totalRow);
  
  if (document.getElementById('labelTotal')) {
    document.getElementById('labelTotal').textContent = '$' + totalAmount.toFixed(2);
  }
  if (detailsContainer) detailsContainer.style.display = 'block';
}

// Auto-init after small delay
setTimeout(initCharts, 500);
</script>

<div class="top-nav">
  <a href="index.html"><button class="back-btn">‚Üê Back to Tracker</button></a>
  <a href="label.html"><button style="background:#9C27B0; color:white;">‚öô Manage Labels</button></a>
  <a href="monthly_analytics.html"><button style="background:#FF9800; color:white;">üìÖ Monthly</button></a>
  <a href="compare_labels.html"><button style="background:#FF5722; color:white;">üìä Compare</button></a>
  <button id="reportBtn" onclick="showReport()" style="background:#4CAF50; color:white;">üìù Report</button>
</div>


<!-- Overall Analytics -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
  <div class="card">
    <h3>Summary</h3>
    <div class="stats-grid">
      <div class="stat-box income">
        <h3>Total Income</h3>
        <div class="value">$<span id="totalIncome">0.00</span></div>
      </div>
      <div class="stat-box expense">
        <h3>Total Expense</h3>
        <div class="value">$<span id="totalExpense">0.00</span></div>
      </div>
      <div class="stat-box">
        <h3>Net Balance</h3>
        <div class="value">$<span id="netBalance">0.00</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Income vs Expense</h3>
    <div class="chart-container">
      <canvas id="incomeExpenseChart"></canvas>
    </div>
  </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px;">
  <div class="card chart-card small" onclick="zoomChart('expenseByLabelChart', 'Expense Breakdown by Category')">
    <button class="zoom-icon">üîç Zoom</button>
    <h3>Expense Breakdown</h3>
    <div class="chart-container" style="height: 250px;">
      <canvas id="expenseByLabelChart"></canvas>
    </div>
  </div>

  <div class="card chart-card small" onclick="zoomChart('incomeByLabelChart', 'Income Breakdown by Category')">
    <button class="zoom-icon">üîç Zoom</button>
    <h3>Income Breakdown</h3>
    <div class="chart-container" style="height: 250px;">
      <canvas id="incomeByLabelChart"></canvas>
    </div>
  </div>

  <div class="card chart-card small" onclick="zoomChart('accountChart', 'Cash vs Bank')">
    <button class="zoom-icon">üîç Zoom</button>
    <h3>Cash vs Bank</h3>
    <div class="chart-container" style="height: 250px;">
      <canvas id="accountChart"></canvas>
    </div>
  </div>
</div>

<div class="card">
  <h3>View Label Details</h3>
  <label for="labelSelect"><strong>Select a Label:</strong></label>
  <select id="labelSelect" onchange="showLabelDetails()">
    <option value="">-- Select a Label --</option>
  </select>
  
  <div id="labelDetailsContainer" class="label-details" style="display:none;">
    <table id="labelDetailsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Account</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody id="labelDetailsBody"></tbody>
    </table>
    <div style="margin-top: 15px; font-size: 18px;">
      Total: <span id="labelTotal" style="color: #2e7d32; font-weight: bold;">$0.00</span>
    </div>
  </div>
</div>


<!-- Zoom Modal -->
<div id="zoomModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeZoom()">‚úï</button>
    <h2 id="zoomTitle" style="margin-top: 0;">Chart</h2>
    <div class="modal-chart">
      <canvas id="zoomChartCanvas"></canvas>
    </div>
  </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal">
  <div class="modal-content" style="max-width:800px;">
    <button class="modal-close" onclick="closeReport()">‚úï</button>
    <h2 style="margin-top:0;">Exportable Report</h2>
    <p style="margin-top:0; color:#555;">Summary text you can copy and send to your advisor.</p>
    <textarea id="reportText" style="flex:1; width:100%; height:60%; padding:10px; font-size:14px; margin-top:10px; border:1px solid #ddd; border-radius:6px; resize:vertical;"></textarea>
    <div style="display:flex; gap:10px; margin-top:12px; justify-content:flex-end;">
      <button style="background:#1976D2; color:white;" onclick="copyReport()">Copy to Clipboard</button>
      <button style="background:#9E9E9E; color:white;" onclick="closeReport()">Close</button>
    </div>
  </div>
</div>

    <!-- Label Compare Modal -->
    <div id="labelCompareModal" class="modal">
      <div class="modal-content" style="max-width:900px;">
        <button class="modal-close" onclick="closeLabelCompareModal()">‚úï</button>
        <h2 style="margin-top:0;">Label Comparison</h2>
        <div id="labelCompareSummary" style="margin-bottom:12px; color:#333;"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; flex:1;">
          <div class="card">
            <h4 style="margin:0 0 8px 0;">Total by Label (stacked Income/Expense)</h4>
            <div style="height:320px;"><canvas id="modalLabelCompareChart"></canvas></div>
          </div>
          <div class="card">
            <h4 style="margin:0 0 8px 0;">Income vs Expense Trend</h4>
            <div style="height:320px;"><canvas id="modalLabelTrendChart"></canvas></div>
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; margin-top:12px; gap:8px;">
          <button style="background:#9E9E9E; color:white;" onclick="closeLabelCompareModal()">Close</button>
        </div>
      </div>
    </div>

<script>
// Load shared storage module FIRST
let selectedCompareLabels = [];

// Chart colors
const colors = [
  '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
  '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
];

// Robust loader to pick up data from shared `storage.js` or localStorage
function loadData(forceParseRaw = false) {
  // Prefer window.data if already available
  try {
    if (window.data && Array.isArray(window.data) && window.data.length > 0) {
      data = window.data;
    } else {
      data = JSON.parse(localStorage.getItem("financeData")) || [];
    }
  } catch (e) {
    console.warn('loadData: parse error, attempting raw parse', e);
    if (forceParseRaw) {
      try {
        const raw = localStorage.getItem('financeData');
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) data = parsed;
        }
      } catch (err) { console.error('loadData raw parse failed', err); }
    }
  }

  // Ensure global sync
  try { window.data = data; } catch(e) {}
  console.log('loadData: items=', data ? data.length : 0);
  const dbg = document.getElementById('debugInfo');
  if (dbg) dbg.textContent = 'Transactions loaded: ' + (data ? data.length : 0);
  
  // Show raw storage for debugging
  const rawStorage = localStorage.getItem('financeData');
  const storageDbg = document.getElementById('storageDebug');
  if (storageDbg) {
    if (!rawStorage) {
      storageDbg.textContent = 'localStorage financeData: (empty or null)';
    } else {
      storageDbg.textContent = 'localStorage financeData: ' + rawStorage.substring(0, 120) + (rawStorage.length > 120 ? '...' : '');
    }
  }
  
  return data;
}

function calculateTotals() {
  let totalIncome = 0;
  let totalExpense = 0;

  data.forEach(t => {
    const amount = parseFloat(t.amount);
    if (t.type === "income") {
      totalIncome += amount;
    } else if (t.type === "expense") {
      totalExpense += amount;
    }
  });

  return { totalIncome, totalExpense };
}

function getExpenseByLabel() {
  const breakdown = {};
  
  data.forEach(t => {
    if (t.type === "expense") {
      if (!breakdown[t.label]) {
        breakdown[t.label] = 0;
      }
      breakdown[t.label] += parseFloat(t.amount);
    }
  });

  return breakdown;
}

function getIncomeByLabel() {
  const breakdown = {};
  
  data.forEach(t => {
    if (t.type === "income") {
      if (!breakdown[t.label]) {
        breakdown[t.label] = 0;
      }
      breakdown[t.label] += parseFloat(t.amount);
    }
  });

  return breakdown;
}

function getAccountBreakdown() {
  let cashIncome = 0, cashExpense = 0;
  let bankIncome = 0, bankExpense = 0;

  data.forEach(t => {
    const amount = parseFloat(t.amount);
    // normalize account value: remove emoji/extra chars and compare case-insensitive
    const acc = (t.account || '').toString().replace(/[^ -\u007F]/g, '').trim();
    const isCash = /cash/i.test(acc);
    // anything not cash considered bank (fallback)

    if (t.type === "income") {
      if (isCash) cashIncome += amount;
      else bankIncome += amount;
    } else if (t.type === "expense") {
      if (isCash) cashExpense += amount;
      else bankExpense += amount;
    }
  });

  return { cashIncome, cashExpense, bankIncome, bankExpense };
}

function updateStats() {
  const { totalIncome, totalExpense } = calculateTotals();
  const netBalance = totalIncome - totalExpense;

  document.getElementById("totalIncome").textContent = totalIncome.toFixed(2);
  document.getElementById("totalExpense").textContent = totalExpense.toFixed(2);
  document.getElementById("netBalance").textContent = netBalance.toFixed(2);
}

function createIncomeExpenseChart() {
  const { totalIncome, totalExpense } = calculateTotals();
  const ctx = document.getElementById("incomeExpenseChart").getContext("2d");
  
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Income", "Expense"],
      datasets: [{
        label: "Amount ($)",
        data: [totalIncome, totalExpense],
        backgroundColor: ["#f093fb", "#4facfe"],
        borderColor: ["#f5576c", "#00f2fe"],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: (value) => "$" + value.toFixed(0) }
        }
      }
    }
  });
}

function createExpenseByLabelChart() {
  const expenseByLabel = getExpenseByLabel();
  const labels = Object.keys(expenseByLabel);
  const amounts = Object.values(expenseByLabel);

  if (labels.length === 0) {
    document.getElementById("expenseByLabelChart").parentElement.innerHTML = "<p>No expense data available</p>";
    return;
  }

  const ctx = document.getElementById("expenseByLabelChart").getContext("2d");
  
  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: labels,
      datasets: [{
        data: amounts,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: "#fff",
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "right" }
      }
    }
  });
}

function createIncomeByLabelChart() {
  const incomeByLabel = getIncomeByLabel();
  const labels = Object.keys(incomeByLabel);
  const amounts = Object.values(incomeByLabel);

  if (labels.length === 0) {
    document.getElementById("incomeByLabelChart").parentElement.innerHTML = "<p>No income data available</p>";
    return;
  }

  const ctx = document.getElementById("incomeByLabelChart").getContext("2d");
  
  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: labels,
      datasets: [{
        data: amounts,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: "#fff",
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "right" }
      }
    }
  });
}

function createAccountChart() {
  const { cashIncome, cashExpense, bankIncome, bankExpense } = getAccountBreakdown();
  const ctx = document.getElementById("accountChart").getContext("2d");
  
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Cash", "Bank"],
      datasets: [
        {
          label: "Income",
          data: [cashIncome, bankIncome],
          backgroundColor: "#f093fb",
          borderColor: "#f5576c",
          borderWidth: 1
        },
        {
          label: "Expense",
          data: [cashExpense, bankExpense],
          backgroundColor: "#4facfe",
          borderColor: "#00f2fe",
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: (value) => "$" + value.toFixed(0) }
        }
      }
    }
  });
}

function reloadData() {
  initCharts();
}

// Auto-reload when localStorage changes in other tabs/windows
window.addEventListener('storage', function(e) {
  if (e.key === 'financeData' || e.key === 'financeLabels') {
    console.log('storage event detected', e.key);
    try { reloadData(); } catch(err) { console.error('reloadData failed', err); }
  }
});

// Global error handler to surface errors during analytics rendering
window.addEventListener('error', function(evt) {
  console.error('Global error caught:', evt.error || evt.message);
  const dbg = document.getElementById('debugInfo');
  if (dbg) dbg.textContent = 'Error: ' + (evt.error ? evt.error.message : evt.message);
});

function populateLabelSelect() {
  // Get all unique labels from transactions
  const allLabels = new Set();
  
  data.forEach(t => {
    allLabels.add(t.label);
  });

  const labelSelect = document.getElementById("labelSelect");
  const sortedLabels = Array.from(allLabels).sort();
  
  sortedLabels.forEach(label => {
    const option = document.createElement("option");
    option.value = label;
    option.textContent = label;
    labelSelect.appendChild(option);
  });
}

// Populate multi-select used for comparisons as well
// (removed standalone multi-select UI)

// Also populate the compare select inside View Label Details
function populateLabelCompareSelect() {
  const allLabels = new Set();
  data.forEach(t => allLabels.add(t.label));
  const sorted = Array.from(allLabels).sort();
  const sel = document.getElementById('labelCompareSelect');
  if (!sel) return;
  sel.innerHTML = '';
  const list = document.getElementById('labelCompareList');
  if (list) list.innerHTML = '';
  sorted.forEach(label => {
    const o = document.createElement('option');
    o.value = label;
    o.textContent = label + ' ‚ìò';
    sel.appendChild(o);

    if (list) {
      const item = document.createElement('div');
      item.className = 'label-compare-item';
      const span = document.createElement('span');
      span.textContent = label;
      const btn = document.createElement('button');
      btn.className = 'add-btn';
      btn.textContent = '+';
      btn.title = 'Add to compare';
      btn.onclick = () => toggleCompareLabel(label, item, btn);
      item.appendChild(span);
      item.appendChild(btn);
      list.appendChild(item);
    }
  });
}

function showLabelDetails() {
  const selectedLabel = document.getElementById("labelSelect").value;
  const detailsContainer = document.getElementById("labelDetailsContainer");
  
  if (!selectedLabel) {
    detailsContainer.style.display = "none";
    return;
  }

  const labelTransactions = data.filter(t => t.label === selectedLabel);
  const tbody = document.getElementById("labelDetailsBody");
  tbody.innerHTML = "";
  
  let totalAmount = 0;

  labelTransactions.forEach(t => {
    const amount = parseFloat(t.amount);
    totalAmount += amount;
    
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${t.date}</td>
      <td>${t.type}</td>
      <td>${t.account}</td>
      <td>$${amount.toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });

  // Add total row
  const totalRow = document.createElement("tr");
  totalRow.className = "label-total";
  totalRow.innerHTML = `
    <td colspan="3" style="text-align: right;">TOTAL</td>
    <td>$${totalAmount.toFixed(2)}</td>
  `;
  tbody.appendChild(totalRow);

  document.getElementById("labelTotal").textContent = "$" + totalAmount.toFixed(2);
  detailsContainer.style.display = "block";
}

// ===== TAB SWITCHING =====
function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll(".tab-content").forEach(tab => {
    tab.classList.remove("active");
  });
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.classList.remove("active");
  });

  // Show selected tab
  document.getElementById(tabName).classList.add("active");
  event.target.classList.add("active");

  // Load monthly data when switching to monthly tab
  if (tabName === "monthly") {
    populateMonthSelect();
    updateMonthlyAnalytics();
  }
}

// ===== MONTHLY ANALYTICS FUNCTIONS =====
function getMonthKey(date) {
  const d = new Date(date);
  return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0');
}

function getMonthsByTransactions() {
  const months = new Set();
  data.forEach(t => {
    months.add(getMonthKey(t.date));
  });
  return Array.from(months).sort().reverse();
}

function populateMonthSelect() {
  const select = document.getElementById("monthSelect");
  const months = getMonthsByTransactions();
  
  select.innerHTML = '<option value="">-- Current Month --</option>';
  
  months.forEach(month => {
    const [year, monthNum] = month.split('-');
    const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
    const option = document.createElement("option");
    option.value = month;
    option.textContent = monthName;
    select.appendChild(option);
  });
}

function getTransactionsForMonth(month) {
  if (!month) {
    const now = new Date();
    month = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
  }
  
  return data.filter(t => getMonthKey(t.date) === month);
}

function getMonthlyStats(month) {
  const transactions = getTransactionsForMonth(month);
  let income = 0, expense = 0;
  
  transactions.forEach(t => {
    const amount = parseFloat(t.amount);
    if (t.type === "income") income += amount;
    else if (t.type === "expense") expense += amount;
  });
  
  return { income, expense, balance: income - expense, count: transactions.length };
}

function updateMonthlyAnalytics() {
  const selectedMonth = document.getElementById("monthSelect").value;
  const stats = getMonthlyStats(selectedMonth);
  const transactions = getTransactionsForMonth(selectedMonth);
  
  // Update stats display
  const statsDiv = document.getElementById("monthlyStats");
  statsDiv.innerHTML = `
    <div class="stats-row">
      <div class="stat-card income">
        <h4>Total Income</h4>
        <div class="value">$${stats.income.toFixed(2)}</div>
      </div>
      <div class="stat-card expense">
        <h4>Total Expense</h4>
        <div class="value">$${stats.expense.toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <h4>Net Balance</h4>
        <div class="value">$${stats.balance.toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <h4>Transactions</h4>
        <div class="value">${stats.count}</div>
      </div>
    </div>
  `;
  
  // Update transactions table
  const tbody = document.getElementById("monthlyTransactionsBody");
  tbody.innerHTML = "";
  
  transactions.forEach(t => {
    const row = document.createElement("tr");
    row.style.borderBottom = "1px solid #eee";
    row.innerHTML = `
      <td style="padding: 10px;">${t.date}</td>
      <td style="padding: 10px;"><strong>${t.type}</strong></td>
      <td style="padding: 10px;">${t.label}</td>
      <td style="padding: 10px;">${t.account}</td>
      <td style="padding: 10px; text-align: right; font-weight: bold;">$${parseFloat(t.amount).toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });
  
  // Create monthly charts
  createMonthlyExpenseChart(selectedMonth, transactions);
  createMonthlyIncomeChart(selectedMonth, transactions);
  createMonthlyTrendChart(selectedMonth);
}

function createMonthlyExpenseChart(month, transactions) {
  const expenseByLabel = {};
  transactions.forEach(t => {
    if (t.type === "expense") {
      expenseByLabel[t.label] = (expenseByLabel[t.label] || 0) + parseFloat(t.amount);
    }
  });
  
  const ctx = document.getElementById("monthlyExpenseChart").getContext("2d");
  const labels = Object.keys(expenseByLabel);
  const amounts = Object.values(expenseByLabel);
  
  if (chartInstances.monthlyExpense) chartInstances.monthlyExpense.destroy();
  
  chartInstances.monthlyExpense = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: labels.length > 0 ? labels : ["No Data"],
      datasets: [{
        data: amounts.length > 0 ? amounts : [1],
        backgroundColor: colors.slice(0, Math.max(labels.length, 1))
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "right" } } }
  });
}

function createMonthlyIncomeChart(month, transactions) {
  const incomeByLabel = {};
  transactions.forEach(t => {
    if (t.type === "income") {
      incomeByLabel[t.label] = (incomeByLabel[t.label] || 0) + parseFloat(t.amount);
    }
  });
  
  const ctx = document.getElementById("monthlyIncomeChart").getContext("2d");
  const labels = Object.keys(incomeByLabel);
  const amounts = Object.values(incomeByLabel);
  
  if (chartInstances.monthlyIncome) chartInstances.monthlyIncome.destroy();
  
  chartInstances.monthlyIncome = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: labels.length > 0 ? labels : ["No Data"],
      datasets: [{
        data: amounts.length > 0 ? amounts : [1],
        backgroundColor: colors.slice(0, Math.max(labels.length, 1))
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "right" } } }
  });
}

function createMonthlyTrendChart(month) {
  const transactions = getTransactionsForMonth(month);
  const dailyData = {};
  
  transactions.forEach(t => {
    const date = t.date;
    if (!dailyData[date]) dailyData[date] = { income: 0, expense: 0 };
    
    const amount = parseFloat(t.amount);
    if (t.type === "income") dailyData[date].income += amount;
    else if (t.type === "expense") dailyData[date].expense += amount;
  });
  
  const dates = Object.keys(dailyData).sort();
  const incomeData = dates.map(d => dailyData[d].income);
  const expenseData = dates.map(d => dailyData[d].expense);
  
  const ctx = document.getElementById("monthlyTrendChart").getContext("2d");
  
  if (chartInstances.monthlyTrend) chartInstances.monthlyTrend.destroy();
  
  chartInstances.monthlyTrend = new Chart(ctx, {
    type: "line",
    data: {
      labels: dates.length > 0 ? dates : ["No Data"],
      datasets: [
        { label: "Income", data: incomeData, borderColor: "#f093fb", backgroundColor: "rgba(240, 147, 251, 0.1)", tension: 0.3 },
        { label: "Expense", data: expenseData, borderColor: "#4facfe", backgroundColor: "rgba(79, 172, 254, 0.1)", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function resetMonthlyData() {
  if (!confirm("Are you sure you want to delete all transactions for the current month? This cannot be undone!")) {
    return;
  }
  
  const now = new Date();
  const currentMonth = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
  
  data = data.filter(t => getMonthKey(t.date) !== currentMonth);
  saveData();
  
  alert("Current month data has been reset!");
  updateMonthlyAnalytics();
}

let chartInstances = {};

function zoomChart(chartId, title) {
  const modal = document.getElementById("zoomModal");
  document.getElementById("zoomTitle").textContent = title;
  
  // Get the original chart
  const originalCanvas = document.getElementById(chartId);
  const chart = Chart.helpers?.instanceFromDOMElement?.(originalCanvas) || Chart.instances?.find(c => c.canvas === originalCanvas);
  
  if (!chart) return;

  // Create zoomed chart
  const zoomCanvas = document.getElementById("zoomChartCanvas");
  const ctx = zoomCanvas.getContext("2d");
  
  // Destroy previous zoom chart if exists
  if (chartInstances.zoomChart) {
    chartInstances.zoomChart.destroy();
  }

  // Create new zoomed chart with same config
  chartInstances.zoomChart = new Chart(ctx, {
    type: chart.config.type,
    data: JSON.parse(JSON.stringify(chart.data)),
    options: JSON.parse(JSON.stringify(chart.options))
  });

  modal.classList.add("show");
}

function closeZoom() {
  const modal = document.getElementById("zoomModal");
  modal.classList.remove("show");
}

// ===== REPORT / EXPORT TEXT =====
function generateReport() {
  loadData(true);

  const { totalIncome, totalExpense } = calculateTotals();
  const net = totalIncome - totalExpense;
  const txCount = data.length;

  const expenseByLabel = getExpenseByLabel();
  const topExpenses = Object.entries(expenseByLabel)
    .sort((a,b) => b[1] - a[1])
    .slice(0,5)
    .map(([label,amt]) => `${label}: $${amt.toFixed(2)}`);

  const incomeByLabel = getIncomeByLabel();
  const topIncomes = Object.entries(incomeByLabel)
    .sort((a,b) => b[1] - a[1])
    .slice(0,5)
    .map(([label,amt]) => `${label}: $${amt.toFixed(2)}`);

  const account = getAccountBreakdown();
  const months = getMonthsByTransactions();

  const selectedMonthElem = document.getElementById("monthSelect");
  const selectedMonth = selectedMonthElem ? selectedMonthElem.value : "";
  const monthKey = selectedMonth || (new Date().getFullYear() + "-" + String(new Date().getMonth()+1).padStart(2,'0'));
  const mStats = getMonthlyStats(selectedMonth);

  const lines = [];
  lines.push("Finance Tracker Report");
  lines.push(`Generated: ${new Date().toLocaleString()}`);
  lines.push("-------------------------------");
  lines.push(`Total Transactions: ${txCount}`);
  lines.push(`Total Income: $${totalIncome.toFixed(2)}`);
  lines.push(`Total Expense: $${totalExpense.toFixed(2)}`);
  lines.push(`Net Balance: $${net.toFixed(2)}`);
  lines.push("");
  lines.push("Top Expense Categories:");
  lines.push(topExpenses.length ? topExpenses.join("; ") : "(no expense data)");
  lines.push("");
  lines.push("Top Income Categories:");
  lines.push(topIncomes.length ? topIncomes.join("; ") : "(no income data)");
  lines.push("");
  lines.push("Account Breakdown:");
  lines.push(`Cash - Income: $${account.cashIncome.toFixed(2)}, Expense: $${account.cashExpense.toFixed(2)}`);
  lines.push(`Bank - Income: $${account.bankIncome.toFixed(2)}, Expense: $${account.bankExpense.toFixed(2)}`);
  lines.push("");
  lines.push(`Available Months In Data: ${months.length > 0 ? months.join(", ") : "(none)"}`);
  lines.push("");
  lines.push(`Snapshot for ${monthKey}:`);
  lines.push(`  Income: $${mStats.income.toFixed(2)}`);
  lines.push(`  Expense: $${mStats.expense.toFixed(2)}`);
  lines.push(`  Net: $${mStats.balance.toFixed(2)}`);
  lines.push(`  Transactions: ${mStats.count}`);
  lines.push("");
  lines.push("Notes: Add any context or highlights here before sending to your advisor.");

  return lines.join("\n");
}

function showReport() {
  const txt = generateReport();
  const ta = document.getElementById("reportText");
  if (ta) ta.value = txt;
  document.getElementById("reportModal").classList.add("show");
}

function closeReport() {
  document.getElementById("reportModal").classList.remove("show");
}

function copyReport() {
  const text = document.getElementById("reportText").value;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => alert('Report copied to clipboard.')).catch(() => fallbackCopyText(text));
  } else {
    fallbackCopyText(text);
  }
}

function fallbackCopyText(text) {
  const ta = document.getElementById("reportText");
  if (!ta) return alert('No report to copy.');
  ta.select();
  try { document.execCommand('copy'); alert('Report copied to clipboard.'); }
  catch (e) { alert('Copy failed. Please select and copy manually.'); }
}

// ===== LABEL COMPARISON CHARTS =====


// Modal versions (render into modal canvases)
function openLabelCompareModal() {
  console.log('openLabelCompareModal called, selected:', window.selectedCompareLabels);
  
  const selected = window.selectedCompareLabels || [];
  if (!selected || selected.length < 2) {
    alert('Please select at least two labels to compare.');
    return;
  }
  
  try {
    // Get transactions
    const rawData = localStorage.getItem('financeData');
    if (!rawData) {
      alert('No transaction data found');
      return;
    }
    
    const transactions = JSON.parse(rawData);
    
    // Build comparison data
    const comparisonData = {};
    selected.forEach(label => {
      const income = transactions.filter(t => t.label === label && t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
      const expense = transactions.filter(t => t.label === label && t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
      comparisonData[label] = { income, expense };
    });
    
    console.log('comparisonData:', comparisonData);
    
    // Summary
    const summary = document.getElementById('labelCompareSummary');
    if (summary) {
      const summaryText = selected.map(l => `${l}: Income $${comparisonData[l].income.toFixed(2)}, Expense $${comparisonData[l].expense.toFixed(2)}`).join(' | ');
      summary.textContent = summaryText;
    }
    
    // Chart 1: Stacked bar (income/expense by label)
    const ctx1 = document.getElementById('modalLabelCompareChart')?.getContext('2d');
    if (ctx1 && window.Chart) {
      if (window.chartCompare1) window.chartCompare1.destroy();
      
      window.chartCompare1 = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: selected,
          datasets: [
            {
              label: 'Income',
              data: selected.map(l => comparisonData[l].income),
              backgroundColor: '#f093fb',
              borderColor: '#f5576c',
              borderWidth: 1
            },
            {
              label: 'Expense',
              data: selected.map(l => comparisonData[l].expense),
              backgroundColor: '#4facfe',
              borderColor: '#00f2fe',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: { 
            y: { beginAtZero: true, ticks: { callback: (v) => '$' + v.toFixed(0) } }
          }
        }
      });
      console.log('Chart 1 created');
    }
    
    // Chart 2: Doughnut (total income vs expense across all selected)
    const ctx2 = document.getElementById('modalLabelTrendChart')?.getContext('2d');
    if (ctx2 && window.Chart) {
      if (window.chartCompare2) window.chartCompare2.destroy();
      
      const totalIncome = selected.reduce((sum, l) => sum + comparisonData[l].income, 0);
      const totalExpense = selected.reduce((sum, l) => sum + comparisonData[l].expense, 0);
      
      window.chartCompare2 = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Total Income', 'Total Expense'],
          datasets: [{
            data: [totalIncome, totalExpense],
            backgroundColor: ['#f093fb', '#4facfe'],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } }
        }
      });
      console.log('Chart 2 created');
    }
    
    const modal = document.getElementById('labelCompareModal');
    console.log('Modal element:', modal);
    if (modal) {
      modal.classList.add('show');
      console.log('Modal shown');
    }
  } catch (e) {
    console.error('Error in openLabelCompareModal:', e);
    alert('Error: ' + e.message);
  }
}

function closeLabelCompareModal() {
  document.getElementById('labelCompareModal').classList.remove('show');
  if (window.chartCompare1) { window.chartCompare1.destroy(); window.chartCompare1 = null; }
  if (window.chartCompare2) { window.chartCompare2.destroy(); window.chartCompare2 = null; }
}

  document.addEventListener('DOMContentLoaded', function() {
    try {
      loadData();
      updateStats();
      createIncomeExpenseChart();
      createExpenseByLabelChart();
      createIncomeByLabelChart();
      createAccountChart();
      populateLabelSelect();
      populateLabelCompareSelect();
    } catch (e) {
      console.error('Init error:', e);
      const dbg = document.getElementById('debugInfo');
      if (dbg) dbg.textContent = 'ERROR: ' + e.message;
    }
  });
} else {
  // Page already loaded
  try {
    loadData();
    updateStats();
    createIncomeExpenseChart();
    createExpenseByLabelChart();
    createIncomeByLabelChart();
    createAccountChart();
    populateLabelSelect();
    populateLabelCompareSelect();
  } catch (e) {
    console.error('Init error:', e);
    const dbg = document.getElementById('debugInfo');
    if (dbg) dbg.textContent = 'ERROR: ' + e.message;
  }
}

</script></body>
</html>
