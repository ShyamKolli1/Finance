<!DOCTYPE html>
<html>
<head>
  <title>Finance Discipline Tracker</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover, user-scalable=yes">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="Track your income, expenses, and manage your finances easily">
  <meta name="format-detection" content="telephone=no"
  
  <!-- iOS specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Finance Tracker">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23667eea' width='180' height='180' rx='40'/><text x='90' y='90' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>üí∞</text></svg>">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Firebase Scripts -->
  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="firebase-sync.js"></script>
  
  <!-- Block page render until auth checked -->
  <script>
    // Hide body content immediately
    document.addEventListener('DOMContentLoaded', () => {
      const authLoading = document.getElementById('authLoading');
      if (authLoading) authLoading.style.display = 'flex';
    });
  </script>
  
  <!-- Auth Check - Redirect if not logged in -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyB6D-f1jwcDwKspzZnzvaXdXalb2HEcELg",
      authDomain: "finance-tracker-ac631.firebaseapp.com",
      projectId: "finance-tracker-ac631"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // Check auth immediately
    onAuthStateChanged(auth, (user) => {
      const loadingDiv = document.getElementById('authLoading');
      
      if (!user) {
        // Not logged in - redirect to login page
        window.location.replace('login.html');
      } else {
        // Logged in - hide loading overlay
        document.body.classList.add('auth-checked');
        if (loadingDiv) {
          loadingDiv.style.display = 'none';
        }
        
        // Show user email
        const userInfoDiv = document.getElementById('userInfo');
        if (userInfoDiv) {
          userInfoDiv.textContent = `üë§ ${user.email}`;
        }
        
        // Auto-enable cloud sync for ALL logged in users
        setTimeout(() => {
          if (window.CloudSync) {
            // Always enable sync when logged in
            window.CloudSync.enable();
            window.CloudSync.syncFromCloud(); // Pull data from cloud
            
            const btn = document.getElementById('syncToggleBtn');
            if (btn) {
              btn.textContent = '‚úÖ Cloud Sync ON';
              btn.style.background = '#2196F3';
            }
            
            console.log('‚úÖ Cloud sync auto-enabled for ' + user.email);
          }
        }, 2000);
      }
    });
  </script>
  
  <link rel="stylesheet" href="styles/main.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      padding: 20px;
    }
    
    /* Hide body content until auth checked */
    body {
      visibility: hidden;
    }
    
    body.auth-checked {
      visibility: visible;
    }
    
    /* Auth Loading Overlay */
    #authLoading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      visibility: visible;
    }
    
    #authLoading .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    #authLoading p {
      color: white;
      margin-top: 20px;
      font-size: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .container { max-width: 1200px; margin: 0 auto; }
    
    .header { 
      text-align: center; 
      color: white; 
      margin-bottom: 30px;
    }
    
    .header h1 { 
      font-size: 32px; 
      margin-bottom: 15px; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .top-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      color: white;
    }
    
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    
    .btn-analytics { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); }
    .btn-labels { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
    
    .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .card:hover { box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
    
    .card h2 { 
      color: #333; 
      font-size: 18px; 
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .balance-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .balance-box {
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      color: white;
    }
    
    .balance-box.cash { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .balance-box.bank { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    
    .balance-box p { font-size: 14px; opacity: 0.9; margin-bottom: 8px; }
    .balance-box .amount { font-size: 28px; font-weight: bold; }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    select, input {
      width: 100%;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      font-family: inherit;
      min-height: 52px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
    }
    
    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    button {
      padding: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      font-size: 16px;
      width: 100%;
      min-height: 52px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .btn-add { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; }
    .btn-add:hover { background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%); }
    
    .btn-clear { background: linear-gradient(135deg, #FF6B6B 0%, #EE5A52 100%); color: white; }
    .btn-clear:hover { background: linear-gradient(135deg, #EE5A52 0%, #E64A39 100%); }
    
    .transactions-section {
      grid-column: 1 / -1;
    }
    
    .transaction-list {
      list-style: none;
      max-height: 500px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .transaction-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 16px;
      background: #f8f9fa;
      margin-bottom: 12px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
      transition: all 0.2s ease;
      touch-action: manipulation;
      min-height: 72px;
    }
    
    .transaction-item:active { 
      background: #e8eaed; 
      transform: scale(0.98);
    }
    
    .transaction-item.expense { border-left-color: #FF6B6B; }
    .transaction-item.income { border-left-color: #4CAF50; }
    .transaction-item.transfer { border-left-color: #2196F3; }
    .transaction-item.saving { border-left-color: #FF9800; }
    
    .transaction-info {
      flex: 1;
    }
    
    .transaction-date { font-size: 13px; color: #999; margin-bottom: 6px; }
    .transaction-label { font-weight: 600; color: #333; font-size: 15px; line-height: 1.4; }
    
    .transaction-amount {
      font-weight: bold;
      font-size: 17px;
      margin-right: 12px;
      min-width: 90px;
      text-align: right;
    }
    
    .transaction-amount.expense { color: #FF6B6B; }
    .transaction-amount.income { color: #4CAF50; }
    
    .btn-delete {
      background: #ffe5e5;
      color: #ff6b6b;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 20px;
      border: 2px solid transparent;
      min-width: 48px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }
    
    .btn-delete:hover { 
      background: #ff6b6b; 
      color: white;
      border-color: #ff6b6b;
    }
    
    .btn-delete:active {
      transform: scale(0.95);
      background: #e65252;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-state p { font-size: 15px; }
    
    @media (max-width: 768px) {
      .dashboard { grid-template-columns: 1fr; }
      .header h1 { font-size: 28px; }
      .balance-grid { grid-template-columns: 1fr; gap: 12px; }
      .balance-box { padding: 24px; }
      .balance-box .amount { font-size: 32px; }
      .form-group { margin-bottom: 18px; }
      .button-group { gap: 14px; }
      .transaction-item { padding: 20px 16px; }
      .transaction-amount { font-size: 18px; min-width: 95px; }
      .btn-delete { font-size: 22px; min-width: 52px; min-height: 52px; }
    }
    
    @media (max-width: 480px) {
      .header h1 { font-size: 24px; }
      .balance-box { padding: 20px; }
      .balance-box .amount { font-size: 28px; }
      .transaction-list { max-height: 450px; }
      .button-group { grid-template-columns: 1fr; gap: 12px; }
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #667eea; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #764ba2; }
  </style>
</head>
<body>

<!-- Auth Loading Overlay -->
<div id="authLoading">
  <div class="spinner"></div>
  <p>üîê Checking login...</p>
</div>

<div class="container">
  <div class="header">
    <h1>üí∞ Finance Discipline Tracker</h1>
  </div>
  
  <div class="top-buttons">
  <a href="pages/analytics/"><button class="btn btn-analytics">üìä Analytics</button></a>
  <a href="pages/labels.html"><button class="btn btn-labels">‚öô Manage Labels</button></a>
  <button id="syncToggleBtn" class="btn" style="background:#4CAF50; color:white;" onclick="toggleCloudSync()">‚òÅÔ∏è Enable Cloud Sync</button>
  <button class="btn" style="background:#ff6b6b; color:white;" onclick="logoutUser()">üö™ Logout</button>
  </div>
  
  <div id="userInfo" style="text-align: center; margin: 10px 0; color: white; font-size: 14px;"></div>
  
  <div class="dashboard">
    <!-- Balance Cards -->
    <div class="card">
      <h2>üí≥ Account Balances</h2>
      <div class="balance-grid">
        <div class="balance-box cash">
          <p>Cash Balance</p>
          <div class="amount">$<span id="cash">0.00</span></div>
        </div>
        <div class="balance-box bank">
          <p>Bank Balance</p>
          <div class="amount">$<span id="bank">0.00</span></div>
        </div>
      </div>
    </div>
    
    <!-- Add Transaction Form -->
    <div class="card">
      <h2>‚ûï Add Transaction</h2>
      
      <div class="form-group">
        <label for="type">Type</label>
        <select id="type" onchange="updateLabels()">
          <option value="expense">üí∏ Expense</option>
          <option value="income">üíµ Income</option>
          <option value="transfer">üîÑ Transfer</option>
          <option value="saving">üè¶ Saving</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="amount">Amount</label>
        <input id="amount" type="number" placeholder="Enter amount" step="0.01">
      </div>
      
      <div class="form-group">
        <label for="label">Label</label>
        <select id="label"></select>
      </div>
      
      <div class="form-group">
        <label for="account">Account</label>
        <select id="account">
          <option value="Cash">üíµ Cash</option>
          <option value="Bank">üèß Bank</option>
        </select>
      </div>
      
      <div class="button-group">
        <button class="btn-add" onclick="addTransaction()">Add Transaction</button>
        <button class="btn-clear" onclick="clearForm()">Clear</button>
      </div>
    </div>
    
    <!-- Transactions List -->
    <div class="card transactions-section">
      <h2>üìã Recent Transactions</h2>
      <ul id="list" class="transaction-list"></ul>
    </div>
  </div>
</div>

<script src="storage.js"></script>
<script>

function updateLabels() {
  const selectedType = document.getElementById("type").value;
  const labelSelect = document.getElementById("label");
  const labels = labelMap[selectedType] || defaultLabels[selectedType] || [];
  
  labelSelect.innerHTML = "";
  labels.forEach(label => {
    const option = document.createElement("option");
    option.value = label;
    option.textContent = label;
    labelSelect.appendChild(option);
  });
}

function clearForm() {
  document.getElementById("type").value = "expense";
  document.getElementById("amount").value = "";
  document.getElementById("account").value = "Cash";
  updateLabels();
}

function addTransaction() {
  const type = document.getElementById("type").value;
  const amount = parseFloat(document.getElementById("amount").value);
  const label = document.getElementById("label").value;
  const accountRaw = document.getElementById("account").value;
  // store canonical account values (Cash/Bank)
  const account = /cash/i.test(normalizeAccount(accountRaw)) ? 'Cash' : 'Bank';
  
  if (!amount || amount <= 0) {
    alert("Please enter a valid amount");
    return;
  }
  
  if (!label) {
    alert("Please select a label");
    return;
  }
  
  const transaction = {
    type: type,
    amount: amount,
    label: label,
    account: account,
    date: new Date().toLocaleDateString()
  };
  
  data.push(transaction);
  saveData();
  render();
  clearForm();
}

function deleteTransaction(index) {
  data.splice(index, 1);
  saveData();
  render();
}

function render() {
  const list = document.getElementById("list");
  list.innerHTML = "";
  
  let cashBalance = 0;
  let bankBalance = 0;
  
  // Calculate balances
  data.forEach(t => {
    let amount = parseFloat(t.amount);
    if (t.type === "income") {
      const acc = normalizeAccount(t.account);
      const isCash = /cash/i.test(acc);
      if (isCash) cashBalance += amount;
      else bankBalance += amount;
    } else if (t.type === "expense") {
      const acc = normalizeAccount(t.account);
      const isCash = /cash/i.test(acc);
      if (isCash) cashBalance -= amount;
      else bankBalance -= amount;
    }
  });
  
  // Display transactions in reverse order (newest first)
  if (data.length === 0) {
    list.innerHTML = '<div class="empty-state"><p>No transactions yet. Add one to get started!</p></div>';
  } else {
    for (let i = data.length - 1; i >= 0; i--) {
      const t = data[i];
      const li = document.createElement("li");
      li.className = `transaction-item ${t.type}`;
      
      const info = document.createElement("div");
      info.className = "transaction-info";
      info.innerHTML = `
        <div class="transaction-date">${t.date}</div>
        <div class="transaction-label">${t.label}</div>
      `;
      
      const amount = document.createElement("div");
      amount.className = `transaction-amount ${t.type}`;
      amount.textContent = (t.type === "expense" ? "- " : "+ ") + "$" + parseFloat(t.amount).toFixed(2);
      
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn-delete";
      deleteBtn.textContent = "üóëÔ∏è";
      deleteBtn.title = "Delete transaction";
      deleteBtn.onclick = () => deleteTransaction(i);
      
      li.appendChild(info);
      li.appendChild(amount);
      li.appendChild(deleteBtn);
      list.appendChild(li);
    }
  }
  
  // Update balance displays
  document.getElementById("cash").textContent = cashBalance.toFixed(2);
  document.getElementById("bank").textContent = bankBalance.toFixed(2);
}

// ===== INITIALIZE =====
document.addEventListener("DOMContentLoaded", function() {
  // Reload labels in case they were updated in another tab
  let stored = localStorage.getItem("financeLabels");
  if (stored) {
    labelMap = JSON.parse(stored);
  }
  
  updateLabels();
  render();
});

// Register service worker for offline support
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').then(reg => {
    console.log('‚úì Service Worker registered');
  }).catch(err => {
    console.log('Service Worker registration failed:', err);
  });
}

// Show user email when logged in
window.addEventListener('load', () => {
  setTimeout(() => {
    if (window.firebaseAuth && window.firebaseAuth.currentUser) {
      const userInfoDiv = document.getElementById('userInfo');
      if (userInfoDiv) {
        userInfoDiv.textContent = `üë§ Logged in as: ${window.firebaseAuth.currentUser.email}`;
      }
    }
  }, 1000);
});

// Logout function
function logoutUser() {
  if (confirm('Are you sure you want to logout?')) {
    if (window.CloudSync) {
      window.CloudSync.logout();
    } else {
      window.location.href = 'login.html';
    }
  }
}

// Cloud Sync Toggle
function toggleCloudSync() {
  const btn = document.getElementById('syncToggleBtn');
  
  if (window.CloudSync && window.CloudSync.isEnabled()) {
    // Disable sync
    window.CloudSync.disable();
    btn.textContent = '‚òÅÔ∏è Enable Cloud Sync';
    btn.style.background = '#4CAF50';
    alert('Cloud sync disabled. Data will only be saved locally.');
  } else if (window.CloudSync) {
    // Enable sync
    window.CloudSync.enable();
    btn.textContent = '‚úÖ Cloud Sync ON';
    btn.style.background = '#2196F3';
    alert('Cloud sync enabled! Your data will sync across all devices. üîÑ');
  } else {
    alert('Cloud sync not available. Firebase not loaded.');
  }
}

// Update sync button text on load
window.addEventListener('load', () => {
  setTimeout(() => {
    const btn = document.getElementById('syncToggleBtn');
    if (btn && window.CloudSync && window.CloudSync.isEnabled()) {
      btn.textContent = '‚úÖ Cloud Sync ON';
      btn.style.background = '#2196F3';
    }
  }, 1000);
});
</script>

</body>
</html>
