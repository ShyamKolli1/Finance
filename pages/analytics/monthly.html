<!DOCTYPE html>
<html>
<head>
  <title>Monthly Analytics - Finance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="module" src="../../firebase-config.js"></script>
  <script type="module">
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    document.documentElement.style.visibility = 'hidden';

    const waitForAuth = setInterval(() => {
      if (window.firebaseAuth) {
        clearInterval(waitForAuth);
        onAuthStateChanged(window.firebaseAuth, (user) => {
          if (!user) {
            window.location.replace('../../login.html');
          } else {
            document.documentElement.style.visibility = 'visible';
          }
        });
      }
    }, 100);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <link rel="stylesheet" href="../../styles/main.css">
  <script src="../../js/app-shell.js"></script>
  <script src="../../storage.js"></script>
  <script src="../../js/utils.js"></script>
  <script src="../../js/ui-enhancements.js"></script>
  <script src="../../js/charts.js"></script>
</head>
<body>

<div style="text-align: center; color: white; margin-bottom: 20px;">
  <h1>üìÖ Monthly Analytics</h1>
  <p style="font-size: 13px; opacity: 0.9;">Home &gt; Analytics &gt; Monthly</p>
</div>

<div id="mainContent" style="max-width: 1400px; margin: 0 auto;">
  <div class="top-nav">
    <a href="../../index.html"><button class="btn-back" aria-label="Back to tracker">‚Üê Back to Tracker</button></a>
    <a href="index.html"><button style="background:#2196F3; color:white;" aria-label="Open overall analytics">üìä Overall Analytics</button></a>
    <a href="compare.html"><button style="background:#FF5722; color:white;" aria-label="Open compare labels">üìä Compare Labels</button></a>
  </div>

  <!-- Month Selector -->
  <div class="card">
    <h3>Select Month</h3>
    <div style="display: flex; gap: 10px; align-items: center;">
      <select id="monthSelect" onchange="updateMonthlyAnalytics()" style="padding: 10px; font-size: 16px;">
        <option value="">-- Current Month --</option>
      </select>
      <button onclick="resetMonthlyData()" class="btn-danger" aria-label="Reset selected month data">üóëÔ∏è Reset Month</button>
    </div>
  </div>

  <!-- Monthly Stats -->
  <div id="monthlyStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
    <div class="card">
      <h4>Total Income</h4>
      <div style="font-size: 24px; font-weight: bold; color: #f093fb;">$0.00</div>
    </div>
    <div class="card">
      <h4>Total Expense</h4>
      <div style="font-size: 24px; font-weight: bold; color: #4facfe;">$0.00</div>
    </div>
    <div class="card">
      <h4>Net Balance</h4>
      <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">$0.00</div>
    </div>
    <div class="card">
      <h4>Transactions</h4>
      <div style="font-size: 24px; font-weight: bold;">0</div>
    </div>
  </div>

  <!-- Charts -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div class="card">
      <h3>Expense by Category</h3>
      <div style="position: relative; height: 300px;">
        <canvas id="monthlyExpenseChart"></canvas>
      </div>
    </div>
    <div class="card">
      <h3>Income by Category</h3>
      <div style="position: relative; height: 300px;">
        <canvas id="monthlyIncomeChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Daily Trend</h3>
    <div style="position: relative; height: 300px;">
      <canvas id="monthlyTrendChart"></canvas>
    </div>
  </div>

  <!-- Transactions Table -->
  <div class="card">
    <h3>Transactions for Selected Month</h3>
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
            <th style="padding: 10px; text-align: left;">Date</th>
            <th style="padding: 10px; text-align: left;">Type</th>
            <th style="padding: 10px; text-align: left;">Category</th>
            <th style="padding: 10px; text-align: left;">Account</th>
            <th style="padding: 10px; text-align: right;">Amount</th>
          </tr>
        </thead>
        <tbody id="monthlyTransactionsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function askConfirm(message, title) {
  if (typeof window.uiConfirm === 'function') {
    return window.uiConfirm(message, title || 'Please Confirm');
  }
  return Promise.resolve(confirm(message));
}

function getMonthKey(dateStr) {
  const [month, day, year] = dateStr.split('/');
  return year + '-' + String(month).padStart(2, '0');
}

function getMonthsByTransactions() {
  const rawData = localStorage.getItem('financeData');
  if (!rawData) return [];
  
  const transactions = JSON.parse(rawData);
  const months = new Set();
  transactions.forEach(t => months.add(getMonthKey(t.date)));
  return Array.from(months).sort().reverse();
}

function populateMonthSelect() {
  const select = document.getElementById('monthSelect');
  const months = getMonthsByTransactions();
  
  select.innerHTML = '<option value="">-- Current Month --</option>';
  months.forEach(monthKey => {
    const [year, month] = monthKey.split('-');
    const monthName = new Date(year, parseInt(month) - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
    const opt = document.createElement('option');
    opt.value = monthKey;
    opt.textContent = monthName;
    select.appendChild(opt);
  });
}

function getTransactionsForMonth(monthKey) {
  const rawData = localStorage.getItem('financeData');
  if (!rawData) return [];
  
  if (!monthKey) {
    const now = new Date();
    monthKey = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  }
  
  const transactions = JSON.parse(rawData);
  return transactions.filter(t => getMonthKey(t.date) === monthKey);
}

function getMonthlyStats(monthKey) {
  const transactions = getTransactionsForMonth(monthKey);
  let income = 0, expense = 0;
  
  transactions.forEach(t => {
    const amt = parseFloat(t.amount);
    if (t.type === 'income') income += amt;
    else if (t.type === 'expense') expense += amt;
  });
  
  return { income, expense, balance: income - expense, count: transactions.length };
}

function updateMonthlyAnalytics() {
  const selectedMonth = document.getElementById('monthSelect').value;
  const stats = getMonthlyStats(selectedMonth);
  const transactions = getTransactionsForMonth(selectedMonth);
  
  // Update stats
  const statsDiv = document.getElementById('monthlyStats');
  statsDiv.innerHTML = `
    <div class="card">
      <h4>Total Income</h4>
      <div style="font-size: 24px; font-weight: bold; color: #f093fb;">$${stats.income.toFixed(2)}</div>
    </div>
    <div class="card">
      <h4>Total Expense</h4>
      <div style="font-size: 24px; font-weight: bold; color: #4facfe;">$${stats.expense.toFixed(2)}</div>
    </div>
    <div class="card">
      <h4>Net Balance</h4>
      <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">$${stats.balance.toFixed(2)}</div>
    </div>
    <div class="card">
      <h4>Transactions</h4>
      <div style="font-size: 24px; font-weight: bold;">${stats.count}</div>
    </div>
  `;
  
  // Update transactions table
  const tbody = document.getElementById('monthlyTransactionsBody');
  tbody.innerHTML = '';
  transactions.forEach(t => {
    const safeDate = typeof window.escapeHtml === 'function' ? window.escapeHtml(t.date) : String(t.date || '');
    const safeType = typeof window.escapeHtml === 'function' ? window.escapeHtml(t.type) : String(t.type || '');
    const safeLabel = typeof window.escapeHtml === 'function' ? window.escapeHtml(t.label) : String(t.label || '');
    const safeAccount = typeof window.escapeHtml === 'function' ? window.escapeHtml(t.account) : String(t.account || '');

    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid #eee';
    row.innerHTML = `
      <td style="padding: 10px;">${safeDate}</td>
      <td style="padding: 10px;"><strong>${safeType}</strong></td>
      <td style="padding: 10px;">${safeLabel}</td>
      <td style="padding: 10px;">${safeAccount}</td>
      <td style="padding: 10px; text-align: right; font-weight: bold;">$${parseFloat(t.amount).toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });
  
  // Create charts
  createMonthlyCharts(transactions);
}

function createMonthlyCharts(transactions) {
  // Expense by label
  const expenseByLabel = {};
  transactions.forEach(t => {
    if (t.type === 'expense') {
      expenseByLabel[t.label] = (expenseByLabel[t.label] || 0) + parseFloat(t.amount);
    }
  });
  
  const expLabels = Object.keys(expenseByLabel);
  destroyChart('monthlyExpense');
  if (expLabels.length > 0) {
    createDoughnutChart('monthlyExpenseChart', expLabels, Object.values(expenseByLabel), 'Expense by Category');
    chartInstances.monthlyExpense = Chart.helpers.instanceFromDOMElement(document.getElementById('monthlyExpenseChart'));
  }
  
  // Income by label
  const incomeByLabel = {};
  transactions.forEach(t => {
    if (t.type === 'income') {
      incomeByLabel[t.label] = (incomeByLabel[t.label] || 0) + parseFloat(t.amount);
    }
  });
  
  const incLabels = Object.keys(incomeByLabel);
  destroyChart('monthlyIncome');
  if (incLabels.length > 0) {
    createDoughnutChart('monthlyIncomeChart', incLabels, Object.values(incomeByLabel), 'Income by Category');
    chartInstances.monthlyIncome = Chart.helpers.instanceFromDOMElement(document.getElementById('monthlyIncomeChart'));
  }
  
  // Daily trend
  const dailyData = {};
  transactions.forEach(t => {
    if (!dailyData[t.date]) dailyData[t.date] = { income: 0, expense: 0 };
    const amt = parseFloat(t.amount);
    if (t.type === 'income') dailyData[t.date].income += amt;
    else if (t.type === 'expense') dailyData[t.date].expense += amt;
  });
  
  const dates = Object.keys(dailyData).sort();
  const days = dates.map(d => d.substr(0, 5)); // MM/DD format
  const incomeData = dates.map(d => dailyData[d].income);
  const expenseData = dates.map(d => dailyData[d].expense);
  
  destroyChart('monthlyTrend');
  const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
  chartInstances.monthlyTrend = new Chart(ctx, {
    type: 'line',
    data: {
      labels: days.length > 0 ? days : ['No Data'],
      datasets: [
        {
          label: 'Income',
          data: incomeData,
          borderColor: '#f093fb',
          backgroundColor: 'rgba(240, 147, 251, 0.1)',
          tension: 0.3,
          borderWidth: 2
        },
        {
          label: 'Expense',
          data: expenseData,
          borderColor: '#4facfe',
          backgroundColor: 'rgba(79, 172, 254, 0.1)',
          tension: 0.3,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true, ticks: { callback: (v) => '$' + v.toFixed(0) } } }
    }
  });
}

async function resetMonthlyData() {
  const approved = await askConfirm('Delete all transactions for the current month?', 'Reset Month');
  if (!approved) return;
  
  const now = new Date();
  const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  
  const rawData = localStorage.getItem('financeData');
  if (!rawData) return;
  
  const transactions = JSON.parse(rawData);
  const filtered = transactions.filter(t => getMonthKey(t.date) !== currentMonth);
  localStorage.setItem('financeData', JSON.stringify(filtered));
  
  alert('Month reset!');
  populateMonthSelect();
  updateMonthlyAnalytics();
}

// Initialize
populateMonthSelect();
setTimeout(updateMonthlyAnalytics, 300);
</script>

</body>
</html>
