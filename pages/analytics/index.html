<!DOCTYPE html>
<html>
<head>
  <title>Analytics - Finance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="module" src="../../firebase-config.js"></script>
  <script type="module">
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    document.documentElement.style.visibility = 'hidden';

    const waitForAuth = setInterval(() => {
      if (window.firebaseAuth) {
        clearInterval(waitForAuth);
        onAuthStateChanged(window.firebaseAuth, (user) => {
          if (!user) {
            window.location.replace('../../login.html');
          } else {
            document.documentElement.style.visibility = 'visible';
          }
        });
      }
    }, 100);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <link rel="stylesheet" href="../../styles/main.css">
  <script src="../../js/app-shell.js"></script>
  <script src="../../storage.js"></script>
  <script src="../../js/utils.js"></script>
  <script src="../../js/ui-enhancements.js"></script>
  <script src="../../js/charts.js"></script>
</head>
<body class="analytics-overview-page">

<div style="text-align: center; color: white; margin-bottom: 20px;">
  <h1>üìä Financial Analytics</h1>
  <p style="font-size: 13px; opacity: 0.9;">Home &gt; Analytics</p>
</div>

<div id="mainContent" style="max-width: 1400px; margin: 0 auto;">
  <div class="top-nav">
    <a href="../../index.html"><button class="btn-back" aria-label="Back to tracker">‚Üê Back to Tracker</button></a>
    <a href="../labels.html"><button style="background:#9C27B0; color:white;" aria-label="Open manage labels">‚öô Manage Labels</button></a>
    <a href="monthly.html"><button style="background:#FF9800; color:white;" aria-label="Open monthly analytics">üìÖ Monthly</button></a>
    <a href="compare.html"><button style="background:#FF5722; color:white;" aria-label="Open compare labels">üìä Compare</button></a>
    <button id="reportBtn" onclick="showReport()" style="background:#4CAF50; color:white;" aria-label="Open report">üìù Report</button>
  </div>

  <div id="debugInfo" style="font-size:13px; color:#666; margin-bottom:8px;">‚è≥ Loading...</div>

  <!-- Summary Stats -->
  <div class="analytics-summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
    <div class="card">
      <h3>Total Income</h3>
      <div style="font-size: 28px; font-weight: bold; color: #f093fb;">$<span id="totalIncome">0.00</span></div>
    </div>
    <div class="card">
      <h3>Total Expense</h3>
      <div style="font-size: 28px; font-weight: bold; color: #4facfe;">$<span id="totalExpense">0.00</span></div>
    </div>
    <div class="card">
      <h3>Net Balance</h3>
      <div style="font-size: 28px; font-weight: bold; color: #4CAF50;">$<span id="netBalance">0.00</span></div>
    </div>
  </div>

  <div class="card" style="margin-bottom: 20px;">
    <h3>Insights</h3>
    <div class="analytics-insights-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div>
        <h4 style="margin-bottom: 10px; text-transform:none; letter-spacing:0;">Net Worth Trend</h4>
        <div id="netWorthTrendInfo" style="font-size:13px; color:#666; margin-bottom:8px;"></div>
        <div style="position: relative; height: 280px;">
          <canvas id="netWorthTrendChart"></canvas>
        </div>
      </div>
      <div>
        <h4 style="margin-bottom: 10px; text-transform:none; letter-spacing:0;">This Month vs Last Month</h4>
        <div id="monthCompareSummary" style="font-size:14px; margin-bottom:8px;"></div>
        <div style="position: relative; height: 280px;">
          <canvas id="monthCompareChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Charts -->
  <div class="analytics-main-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div class="card" style="position: relative;">
      <button class="zoom-icon" onclick="zoomChart('incomeExpenseChart', 'Income vs Expense')">üîç</button>
      <h3>Income vs Expense</h3>
      <div style="position: relative; height: 300px;">
        <canvas id="incomeExpenseChart"></canvas>
      </div>
    </div>

    <div class="card" style="position: relative;">
      <button class="zoom-icon" onclick="zoomChart('accountChart', 'Cash vs Bank')">üîç</button>
      <h3>Cash vs Bank</h3>
      <div style="position: relative; height: 300px;">
        <canvas id="accountChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Category Breakdowns -->
  <div class="analytics-breakdown-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div class="card" style="position: relative;">
      <button class="zoom-icon" onclick="zoomChart('expenseByLabelChart', 'Expense Breakdown')">üîç</button>
      <h3>Expense by Category</h3>
      <div style="position: relative; height: 300px;">
        <canvas id="expenseByLabelChart"></canvas>
      </div>
    </div>

    <div class="card" style="position: relative;">
      <button class="zoom-icon" onclick="zoomChart('incomeByLabelChart', 'Income Breakdown')">üîç</button>
      <h3>Income by Category</h3>
      <div style="position: relative; height: 300px;">
        <canvas id="incomeByLabelChart"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>Account Split</h3>
      <table style="width: 100%; font-size: 14px;">
        <tbody id="accountSplitBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Label Details -->
  <div class="card">
    <h3>View Label Details</h3>
    <label for="labelSelect"><strong>Select a Label:</strong></label>
    <select id="labelSelect" onchange="showLabelDetails()">
      <option value="">-- Select a Label --</option>
    </select>
    
    <div id="labelDetailsContainer" style="display:none; margin-top: 20px;">
      <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
              <th style="padding: 10px; text-align: left;">Date</th>
              <th style="padding: 10px; text-align: left;">Type</th>
              <th style="padding: 10px; text-align: left;">Account</th>
              <th style="padding: 10px; text-align: right;">Amount</th>
            </tr>
          </thead>
          <tbody id="labelDetailsBody"></tbody>
        </table>
      </div>
      <div style="margin-top: 15px; font-size: 18px; font-weight: bold;">
        Total: $<span id="labelTotal">0.00</span>
      </div>
    </div>
  </div>
</div>

<!-- Zoom Modal -->
<div id="zoomModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeZoom()">‚úï</button>
    <h2 id="zoomTitle" style="margin-top: 0;">Chart</h2>
    <div style="position: relative; height: 400px;">
      <canvas id="zoomChartCanvas"></canvas>
    </div>
  </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <button class="modal-close" onclick="closeReport()">‚úï</button>
    <h2 style="margin-top: 0;">Exportable Report</h2>
    <textarea id="reportText" style="width: 100%; height: 60%; padding: 10px; margin: 15px 0; border: 1px solid #ddd; border-radius: 6px; font-family: monospace;"></textarea>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button class="btn-primary" onclick="copyReport()">Copy to Clipboard</button>
      <button class="btn-secondary" onclick="closeReport()">Close</button>
    </div>
  </div>
</div>

<script>
let netWorthChartInstance = null;
let monthCompareChartInstance = null;

function parseDateSafe(rawDate) {
  if (!rawDate) return null;
  const direct = new Date(rawDate);
  if (!Number.isNaN(direct.getTime())) return direct;

  const parts = String(rawDate).split('/');
  if (parts.length === 3) {
    const month = Number(parts[0]);
    const day = Number(parts[1]);
    const year = Number(parts[2]);
    const parsed = new Date(year, month - 1, day);
    if (!Number.isNaN(parsed.getTime())) return parsed;
  }
  return null;
}

function getMonthKeyFromDate(rawDate) {
  const d = parseDateSafe(rawDate);
  if (!d) return '';
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
}

function loadLabelMeta() {
  try {
    const raw = localStorage.getItem('financeLabelMeta');
    const parsed = raw ? JSON.parse(raw) : {};
    return parsed && typeof parsed === 'object' ? parsed : {};
  } catch (_) {
    return {};
  }
}

function formatLabelForDisplay(label, labelMeta) {
  const name = String(label || 'Other');
  const meta = labelMeta[name] || {};
  return `${meta.icon ? meta.icon + ' ' : ''}${name}`;
}

function renderAccountSplitTable(accountStats) {
  const body = document.getElementById('accountSplitBody');
  if (!body) return;

  const rows = Object.keys(accountStats)
    .sort((a, b) => a.localeCompare(b))
    .map((account, index, all) => {
      const row = accountStats[account];
      const border = index === all.length - 1 ? '' : ' style="border-bottom: 1px solid #eee;"';
      return `
        <tr${border}>
          <td><strong>${typeof window.escapeHtml === 'function' ? window.escapeHtml(account) : account}</strong></td>
          <td style="text-align:right; color:#2e7d32;">+$${row.income.toFixed(2)}</td>
          <td style="text-align:right; color:#c62828;">-$${row.expense.toFixed(2)}</td>
          <td style="text-align:right;"><strong>$${(row.income - row.expense).toFixed(2)}</strong></td>
        </tr>
      `;
    });

  body.innerHTML = `
    <tr style="border-bottom: 1px solid #ddd; background:#f7f8fc;">
      <td><strong>Account</strong></td>
      <td style="text-align:right;"><strong>Income</strong></td>
      <td style="text-align:right;"><strong>Expense</strong></td>
      <td style="text-align:right;"><strong>Net</strong></td>
    </tr>
    ${rows.join('')}
  `;
}

function renderNetWorthAndMonthComparison(transactions) {
  const trendCanvas = document.getElementById('netWorthTrendChart');
  const compareCanvas = document.getElementById('monthCompareChart');
  const trendInfo = document.getElementById('netWorthTrendInfo');
  const compareSummary = document.getElementById('monthCompareSummary');
  if (!trendCanvas || !compareCanvas || !trendInfo || !compareSummary) return;

  const sorted = transactions
    .filter((item) => ['income', 'expense'].includes(item.type))
    .slice()
    .sort((a, b) => {
      const aDate = parseDateSafe(a.date);
      const bDate = parseDateSafe(b.date);
      return (aDate ? aDate.getTime() : 0) - (bDate ? bDate.getTime() : 0);
    });

  const points = [];
  let running = 0;
  sorted.forEach((item) => {
    const amount = Number(item.amount || 0);
    if (!Number.isFinite(amount)) return;
    running += item.type === 'expense' ? -amount : amount;
    points.push({
      label: item.date || '',
      value: running
    });
  });

  if (netWorthChartInstance) netWorthChartInstance.destroy();
  netWorthChartInstance = new Chart(trendCanvas.getContext('2d'), {
    type: 'line',
    data: {
      labels: points.map((p) => p.label),
      datasets: [{
        label: 'Running Net Worth',
        data: points.map((p) => p.value),
        borderColor: '#667eea',
        backgroundColor: 'rgba(102,126,234,0.15)',
        borderWidth: 2,
        fill: true,
        tension: 0.25,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { ticks: { callback: (v) => '$' + Number(v).toFixed(0) } } }
    }
  });

  trendInfo.textContent = points.length
    ? `Latest net worth: $${Number(points[points.length - 1].value || 0).toFixed(2)}`
    : 'Add income/expense transactions to see the trend.';

  const now = new Date();
  const prev = new Date(now);
  prev.setMonth(prev.getMonth() - 1);
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  const previousMonth = `${prev.getFullYear()}-${String(prev.getMonth() + 1).padStart(2, '0')}`;

  const sumByMonthType = (monthKey, type) => transactions
    .filter((item) => item.type === type && getMonthKeyFromDate(item.date) === monthKey)
    .reduce((sum, item) => sum + Number(item.amount || 0), 0);

  const incomeNow = sumByMonthType(currentMonth, 'income');
  const expenseNow = sumByMonthType(currentMonth, 'expense');
  const incomePrev = sumByMonthType(previousMonth, 'income');
  const expensePrev = sumByMonthType(previousMonth, 'expense');

  if (monthCompareChartInstance) monthCompareChartInstance.destroy();
  monthCompareChartInstance = new Chart(compareCanvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: ['Income', 'Expense'],
      datasets: [
        { label: 'This Month', data: [incomeNow, expenseNow], backgroundColor: '#4caf50' },
        { label: 'Last Month', data: [incomePrev, expensePrev], backgroundColor: '#90caf9' }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, ticks: { callback: (v) => '$' + Number(v).toFixed(0) } } }
    }
  });

  compareSummary.innerHTML = `
    <div>Income: $${incomeNow.toFixed(2)} (Last: $${incomePrev.toFixed(2)})</div>
    <div>Expense: $${expenseNow.toFixed(2)} (Last: $${expensePrev.toFixed(2)})</div>
    <div style="margin-top:6px; font-weight:700;">Net delta: $${((incomeNow - expenseNow) - (incomePrev - expensePrev)).toFixed(2)}</div>
  `;
}

function initCharts() {
  try {
    const rawData = localStorage.getItem('financeData');
    if (!rawData) {
      document.getElementById('debugInfo').textContent = 'No transactions found';
      return;
    }
    
    const transactions = JSON.parse(rawData);
    document.getElementById('debugInfo').textContent = '‚úì ' + transactions.length + ' transactions loaded';
    
    if (!Array.isArray(transactions) || transactions.length === 0) return;
    
    const labelMeta = loadLabelMeta();
    const storedAccountsRaw = localStorage.getItem('financeAccounts');
    let storedAccounts = ['Cash', 'Bank'];
    try {
      storedAccounts = storedAccountsRaw ? JSON.parse(storedAccountsRaw) : ['Cash', 'Bank'];
    } catch (_) {
      storedAccounts = ['Cash', 'Bank'];
    }
    const accountSet = new Set(Array.isArray(storedAccounts) ? storedAccounts : ['Cash', 'Bank']);

    // Calculate totals
    let totalIncome = 0, totalExpense = 0;
    let expenseByLabel = {}, incomeByLabel = {};
    const accountStats = {};

    accountSet.forEach((name) => {
      accountStats[String(name)] = { income: 0, expense: 0 };
    });
    
    transactions.forEach(t => {
      const amt = parseFloat(t.amount);
      if (!Number.isFinite(amt) || amt <= 0) return;
      const account = String(t.account || 'Cash').trim() || 'Cash';
      if (!accountStats[account]) accountStats[account] = { income: 0, expense: 0 };
      
      if (t.type === 'income') {
        totalIncome += amt;
        if (Array.isArray(t.splits) && t.splits.length) {
          t.splits.forEach((split) => {
            const splitAmt = Number(split.amount || 0);
            if (!Number.isFinite(splitAmt) || splitAmt <= 0) return;
            const key = formatLabelForDisplay(split.label || t.label || 'Other', labelMeta);
            incomeByLabel[key] = (incomeByLabel[key] || 0) + splitAmt;
          });
        } else {
          const key = formatLabelForDisplay(t.label || 'Other', labelMeta);
          incomeByLabel[key] = (incomeByLabel[key] || 0) + amt;
        }
        accountStats[account].income += amt;
      } else if (t.type === 'expense') {
        totalExpense += amt;
        if (Array.isArray(t.splits) && t.splits.length) {
          t.splits.forEach((split) => {
            const splitAmt = Number(split.amount || 0);
            if (!Number.isFinite(splitAmt) || splitAmt <= 0) return;
            const key = formatLabelForDisplay(split.label || t.label || 'Other', labelMeta);
            expenseByLabel[key] = (expenseByLabel[key] || 0) + splitAmt;
          });
        } else {
          const key = formatLabelForDisplay(t.label || 'Other', labelMeta);
          expenseByLabel[key] = (expenseByLabel[key] || 0) + amt;
        }
        accountStats[account].expense += amt;
      }
    });
    
    // Update stat displays
    document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
    document.getElementById('totalExpense').textContent = totalExpense.toFixed(2);
    document.getElementById('netBalance').textContent = (totalIncome - totalExpense).toFixed(2);

    renderAccountSplitTable(accountStats);
    
    // Create charts using utility functions
    createIncomeExpenseChart('incomeExpenseChart', totalIncome, totalExpense);
    const accountLabels = Object.keys(accountStats).sort((a, b) => a.localeCompare(b));
    const incomeSeries = accountLabels.map((name) => accountStats[name].income || 0);
    const expenseSeries = accountLabels.map((name) => accountStats[name].expense || 0);
    createStackedBarChart('accountChart', accountLabels, incomeSeries, expenseSeries, 'Income', 'Expense');
    createDoughnutChart('expenseByLabelChart', Object.keys(expenseByLabel), Object.values(expenseByLabel), 'Expense by Label');
    createDoughnutChart('incomeByLabelChart', Object.keys(incomeByLabel), Object.values(incomeByLabel), 'Income by Label');
    renderNetWorthAndMonthComparison(transactions);
    
    // Populate label select
    const allLabels = [...new Set(transactions.map(t => t.label))].sort();
    const labelSelect = document.getElementById('labelSelect');
    labelSelect.innerHTML = '<option value="">-- Select a Label --</option>';
    allLabels.forEach(label => {
      const opt = document.createElement('option');
      opt.value = label;
      opt.textContent = formatLabelForDisplay(label, labelMeta);
      labelSelect.appendChild(opt);
    });
    
  } catch (e) {
    document.getElementById('debugInfo').textContent = 'Error: ' + e.message;
    console.error(e);
  }
}

function showLabelDetails() {
  const rawData = localStorage.getItem('financeData');
  if (!rawData) return;
  
  const transactions = JSON.parse(rawData);
  const selectedLabel = document.getElementById('labelSelect').value;
  const detailsContainer = document.getElementById('labelDetailsContainer');
  
  if (!selectedLabel) {
    detailsContainer.style.display = 'none';
    return;
  }
  
  const labelTransactions = transactions.filter(t => t.label === selectedLabel);
  const tbody = document.getElementById('labelDetailsBody');
  tbody.innerHTML = '';
  
  let totalAmount = 0;
  labelTransactions.forEach(t => {
    const amount = parseFloat(t.amount);
    totalAmount += amount;

    const safeDate = typeof window.escapeHtml === 'function' ? window.escapeHtml(t.date) : String(t.date || '');
    const safeType = typeof window.escapeHtml === 'function' ? window.escapeHtml(t.type) : String(t.type || '');
    const safeAccount = typeof window.escapeHtml === 'function' ? window.escapeHtml(t.account) : String(t.account || '');
    
    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid #eee';
    row.innerHTML = `
      <td style="padding: 10px;">${safeDate}</td>
      <td style="padding: 10px;"><strong>${safeType}</strong></td>
      <td style="padding: 10px;">${safeAccount}</td>
      <td style="padding: 10px; text-align: right;">$${amount.toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });
  
  document.getElementById('labelTotal').textContent = totalAmount.toFixed(2);
  detailsContainer.style.display = 'block';
}

function generateReport() {
  const rawData = localStorage.getItem('financeData');
  if (!rawData) return 'No transaction data found.';
  
  const transactions = JSON.parse(rawData);
  let totalIncome = 0, totalExpense = 0, expenseByLabel = {}, incomeByLabel = {};
  
  transactions.forEach(t => {
    const amt = parseFloat(t.amount);
    if (t.type === 'income') {
      totalIncome += amt;
      incomeByLabel[t.label] = (incomeByLabel[t.label] || 0) + amt;
    } else if (t.type === 'expense') {
      totalExpense += amt;
      expenseByLabel[t.label] = (expenseByLabel[t.label] || 0) + amt;
    }
  });
  
  const topExpenses = Object.entries(expenseByLabel)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([label, amt]) => `${label}: $${amt.toFixed(2)}`)
    .join('; ') || '(no data)';
  
  const topIncomes = Object.entries(incomeByLabel)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([label, amt]) => `${label}: $${amt.toFixed(2)}`)
    .join('; ') || '(no data)';
  
  const lines = [
    'Finance Tracker Report',
    `Generated: ${new Date().toLocaleString()}`,
    '-------------------------------',
    `Total Transactions: ${transactions.length}`,
    `Total Income: $${totalIncome.toFixed(2)}`,
    `Total Expense: $${totalExpense.toFixed(2)}`,
    `Net Balance: $${(totalIncome - totalExpense).toFixed(2)}`,
    '',
    'Top Expense Categories:',
    topExpenses,
    '',
    'Top Income Categories:',
    topIncomes,
    '',
    'Notes: Add any context or highlights here before sending to your advisor.'
  ];
  
  return lines.join('\n');
}

function showReport() {
  document.getElementById('reportText').value = generateReport();
  document.getElementById('reportModal').classList.add('show');
}

function closeReport() {
  document.getElementById('reportModal').classList.remove('show');
}

function copyReport() {
  const text = document.getElementById('reportText').value;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => alert('Report copied!'));
  } else {
    document.getElementById('reportText').select();
    document.execCommand('copy');
    alert('Report copied!');
  }
}

// Initialize on load
setTimeout(initCharts, 300);
window.addEventListener('storage', () => initCharts());
</script>

</body>
</html>
