<!DOCTYPE html>
<html>
<head>
  <title>Compare Labels - Finance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <link rel="stylesheet" href="../../styles/main.css">
  <script src="../../storage.js"></script>
  <script src="../../js/utils.js"></script>
  <script src="../../js/charts.js"></script>
</head>
<body>

<div style="text-align: center; color: white; margin-bottom: 20px;">
  <h1>üìä Compare Labels</h1>
</div>

<div style="max-width: 1200px; margin: 0 auto;">
  <div class="top-nav">
    <a href="../../index.html"><button class="btn-back">‚Üê Back to Tracker</button></a>
    <a href="index.html"><button style="background:#2196F3; color:white;">üìä Overall Analytics</button></a>
    <a href="monthly.html"><button style="background:#FF9800; color:white;">üìÖ Monthly</button></a>
  </div>

  <!-- Label Selection -->
  <div class="card">
    <h3>Select Labels to Compare</h3>
    <p style="color: #666; margin-bottom: 15px;">Click the + button to add a label, then click Compare</p>
    
    <div id="labelCompareList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; margin-bottom: 20px;">
      <!-- Will be populated by script -->
    </div>
    
    <button id="compareBtn" onclick="openLabelCompareModal()" class="btn-primary" disabled>üìä Compare Selected Labels</button>
  </div>
</div>

<!-- Comparison Modal -->
<div id="labelCompareModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <button class="modal-close" onclick="closeLabelCompareModal()">‚úï</button>
    <h2 style="margin-top: 0;">Label Comparison</h2>
    <div id="labelCompareSummary" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 6px; color: #333;"></div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
      <div class="card">
        <h4 style="margin: 0 0 15px 0;">Income vs Expense (Stacked)</h4>
        <div style="position: relative; height: 320px;">
          <canvas id="modalLabelCompareChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h4 style="margin: 0 0 15px 0;">Total Breakdown</h4>
        <div style="position: relative; height: 320px;">
          <canvas id="modalLabelTrendChart"></canvas>
        </div>
      </div>
    </div>
    
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button class="btn-secondary" onclick="closeLabelCompareModal()">Close</button>
    </div>
  </div>
</div>

<script>
let selectedCompareLabels = [];

function populateLabelCompareList() {
  const rawData = localStorage.getItem('financeData');
  if (!rawData) return;
  
  const transactions = JSON.parse(rawData);
  const labels = [...new Set(transactions.map(t => t.label))].sort();
  
  const listContainer = document.getElementById('labelCompareList');
  listContainer.innerHTML = '';
  
  labels.forEach(label => {
    const item = document.createElement('div');
    item.className = 'label-compare-item';
    item.id = 'compare-item-' + label;
    
    const span = document.createElement('span');
    span.textContent = label;
    span.style.flex = '1';
    
    const btn = document.createElement('button');
    btn.className = 'add-btn';
    btn.textContent = '+';
    btn.title = 'Add to compare';
    btn.onclick = (e) => {
      e.stopPropagation();
      toggleCompareLabel(label, item, btn);
    };
    
    item.appendChild(span);
    item.appendChild(btn);
    listContainer.appendChild(item);
  });
}

function toggleCompareLabel(label, itemEl, btnEl) {
  const idx = selectedCompareLabels.indexOf(label);
  if (idx === -1) {
    selectedCompareLabels.push(label);
    itemEl.classList.add('selected');
    btnEl.classList.add('selected');
    btnEl.textContent = '‚úì';
  } else {
    selectedCompareLabels.splice(idx, 1);
    itemEl.classList.remove('selected');
    btnEl.classList.remove('selected');
    btnEl.textContent = '+';
  }
  
  document.getElementById('compareBtn').disabled = selectedCompareLabels.length < 2;
}

function openLabelCompareModal() {
  if (!selectedCompareLabels || selectedCompareLabels.length < 2) {
    alert('Please select at least 2 labels to compare');
    return;
  }
  
  try {
    const rawData = localStorage.getItem('financeData');
    if (!rawData) {
      alert('No transaction data found');
      return;
    }
    
    const transactions = JSON.parse(rawData);
    
    // Build comparison data
    const comparisonData = {};
    selectedCompareLabels.forEach(label => {
      const income = transactions
        .filter(t => t.label === label && t.type === 'income')
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);
      const expense = transactions
        .filter(t => t.label === label && t.type === 'expense')
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);
      comparisonData[label] = { income, expense };
    });
    
    // Summary
    const summary = document.getElementById('labelCompareSummary');
    const summaryText = selectedCompareLabels
      .map(l => `<strong>${l}</strong>: Income $${comparisonData[l].income.toFixed(2)}, Expense $${comparisonData[l].expense.toFixed(2)}`)
      .join(' | ');
    summary.innerHTML = summaryText;
    
    // Chart 1: Stacked bar
    const ctx1 = document.getElementById('modalLabelCompareChart')?.getContext('2d');
    if (ctx1 && window.Chart) {
      destroyChart('compareStacked');
      chartInstances.compareStacked = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: selectedCompareLabels,
          datasets: [
            {
              label: 'Income',
              data: selectedCompareLabels.map(l => comparisonData[l].income),
              backgroundColor: '#f093fb',
              borderColor: '#f5576c',
              borderWidth: 1
            },
            {
              label: 'Expense',
              data: selectedCompareLabels.map(l => comparisonData[l].expense),
              backgroundColor: '#4facfe',
              borderColor: '#00f2fe',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: {
            y: { beginAtZero: true, ticks: { callback: (v) => '$' + v.toFixed(0) } }
          }
        }
      });
    }
    
    // Chart 2: Doughnut of total
    const ctx2 = document.getElementById('modalLabelTrendChart')?.getContext('2d');
    if (ctx2 && window.Chart) {
      destroyChart('compareDoughnut');
      
      const totalIncome = selectedCompareLabels.reduce((sum, l) => sum + comparisonData[l].income, 0);
      const totalExpense = selectedCompareLabels.reduce((sum, l) => sum + comparisonData[l].expense, 0);
      
      chartInstances.compareDoughnut = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Total Income', 'Total Expense'],
          datasets: [{
            data: [totalIncome, totalExpense],
            backgroundColor: ['#f093fb', '#4facfe'],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } }
        }
      });
    }
    
    document.getElementById('labelCompareModal').classList.add('show');
  } catch (e) {
    console.error('Error:', e);
    alert('Error: ' + e.message);
  }
}

function closeLabelCompareModal() {
  document.getElementById('labelCompareModal').classList.remove('show');
  destroyChart('compareStacked');
  destroyChart('compareDoughnut');
}

// Initialize
populateLabelCompareList();
</script>

</body>
</html>
